<% content_for :vite_page, true %>
<% content_for :main_container_class, 'w-full bg-base-200 min-h-screen' %>

<div class="container mx-auto px-4 py-8 max-w-7xl">
  <%= render 'shared/flash' if flash.any? %>

  <% if @habit_plan.nil? %>
    <!-- No Plan Found for Selected Duration -->
    <div class="min-h-screen bg-base-200 flex items-center justify-center">
      <div class="card bg-base-100 shadow-xl max-w-md">
        <div class="card-body text-center">
          <h2 class="card-title text-2xl justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </h2>
          <h3 class="text-xl font-semibold mb-2">No <%= @duration_type.titleize %> Plan Found</h3>
          <p class="text-base-content/70 mb-4">You don't have a <%= @duration_type.titleize %> habit plan yet.</p>
          <%= link_to "Back to Dashboard", dashboard_path, class: "btn btn-primary" %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- Enhanced Habit Plan Header -->
    <div class="mb-8">
      <!-- MindFlow Header -->
      <div class="relative mb-8">
        <!-- Clean Navigation Bar -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center">
                <span class="text-white font-bold text-lg">MF</span>
              </div>
              <h1 class="text-2xl font-bold text-base-content">MindFlow</h1>
            </div>
            <div class="hidden md:flex items-center gap-1 text-sm text-base-content/60">
              <span>Biohacking Dashboard</span>
              <div class="w-1 h-1 rounded-full bg-emerald-500"></div>
              <span>Live</span>
            </div>
          </div>
          
          <div class="flex items-center gap-4">
            <div class="text-right">
              <div class="text-sm font-medium text-base-content">
                <%= case Time.current.hour
                    when 5..11 then "Morning Optimization"
                    when 12..17 then "Peak Performance"
                    when 18..21 then "Evening Recovery"
                    else "Biohacking Protocol"
                    end %>
              </div>
              <div class="text-xs text-base-content/60"><%= Time.current.strftime("%A, %B %d") %></div>
            </div>
            <%= link_to dashboard_path, class: "w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center text-white hover:scale-105 transition-transform" do %>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
              </svg>
            <% end %>
          </div>
        </div>

        <!-- Biohacking Stats Overview -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Focus Score Card -->
          <div class="card bg-base-100/80 backdrop-blur-xl border border-blue-200/20 shadow-lg hover:shadow-blue-500/10 transition-all">
            <div class="card-body p-6 text-center">
              <div class="text-sm text-blue-500/80 mb-2">Focus Index</div>
              <div class="relative w-24 h-24 mx-auto mb-3">
                <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 36 36">
                  <path
                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeDasharray="100, 100"
                    class="text-base-300"
                  />
                  <path
                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                    fill="none"
                    stroke="url(#focusGradient)"
                    strokeWidth="2"
                    strokeDasharray="85, 100"
                    class="drop-shadow-sm"
                  />
                  <defs>
                    <linearGradient id="focusGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#3B82F6" />
                      <stop offset="100%" stopColor="#10B981" />
                    </linearGradient>
                  </defs>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span class="text-2xl font-bold text-base-content">85%</span>
                </div>
              </div>
              <div class="text-xs text-emerald-500 flex items-center justify-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
                <span>‚Üë 8% from yesterday</span>
              </div>
            </div>
          </div>

          <!-- Streak Overview -->
          <div class="card bg-base-100/80 backdrop-blur-xl border border-emerald-200/20 shadow-lg hover:shadow-emerald-500/10 transition-all">
            <div class="card-body p-6">
              <div class="text-sm text-emerald-500/80 mb-4">Habit Streaks</div>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üßò‚Äç‚ôÇÔ∏è</span>
                    <span class="text-sm font-medium">Meditation</span>
                  </div>
                  <div class="text-right">
                    <div class="text-sm font-bold text-base-content">12d</div>
                    <div class="w-16 h-1 bg-base-300 rounded-full">
                      <div class="h-full bg-emerald-500 rounded-full" style="width: 90%"></div>
                    </div>
                  </div>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">‚úçÔ∏è</span>
                    <span class="text-sm font-medium">Journaling</span>
                  </div>
                  <div class="text-right">
                    <div class="text-sm font-bold text-base-content">8d</div>
                    <div class="w-16 h-1 bg-base-300 rounded-full">
                      <div class="h-full bg-blue-500 rounded-full" style="width: 75%"></div>
                    </div>
                  </div>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üíß</span>
                    <span class="text-sm font-medium">Hydration</span>
                  </div>
                  <div class="text-right">
                    <div class="text-sm font-bold text-base-content">15d</div>
                    <div class="w-16 h-1 bg-base-300 rounded-full">
                      <div class="h-full bg-blue-400 rounded-full" style="width: 95%"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Weekly Trend -->
          <div class="card bg-base-100/80 backdrop-blur-xl border border-purple-200/20 shadow-lg hover:shadow-purple-500/10 transition-all">
            <div class="card-body p-6">
              <div class="text-sm text-purple-500/80 mb-4">Weekly Trends</div>
              <div class="h-20 relative">
                <svg class="w-full h-full" viewBox="0 0 100 60">
                  <defs>
                    <linearGradient id="focusLine" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#3B82F6" />
                      <stop offset="100%" stopColor="#10B981" />
                    </linearGradient>
                  </defs>
                  <path
                    d="M10,45 Q25,35 40,40 T70,30 T90,25"
                    fill="none"
                    stroke="url(#focusLine)"
                    strokeWidth="2"
                    class="drop-shadow-sm"
                  />
                  <path
                    d="M10,35 Q25,40 40,35 T70,45 T90,40"
                    fill="none"
                    stroke="#8B5CF6"
                    strokeWidth="2"
                    strokeDasharray="2,2"
                  />
                </svg>
                <div class="absolute bottom-0 left-0 text-xs text-base-content/60">Focus vs Calm</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Duration Type Tabs -->
      <div class="flex gap-2 p-1 bg-base-100 rounded-2xl shadow-lg w-fit">
        <%= link_to my_habit_plan_path(duration_type: 'daily'), 
            class: "px-6 py-3 rounded-xl font-semibold transition-all duration-300 #{@duration_type == 'daily' ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white shadow-lg' : 'text-base-content hover:bg-base-200'}" do %>
          üöÄ Today's Stack
        <% end %>
        <%= link_to my_habit_plan_path(duration_type: 'three_month'), 
            class: "px-6 py-3 rounded-xl font-semibold transition-all duration-300 #{@duration_type == 'three_month' ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white shadow-lg' : 'text-base-content hover:bg-base-200'}" do %>
          üìà This Quarter
        <% end %>
        <%= link_to my_habit_plan_path(duration_type: 'six_month'), 
            class: "px-6 py-3 rounded-xl font-semibold transition-all duration-300 #{@duration_type == 'six_month' ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white shadow-lg' : 'text-base-content hover:bg-base-200'}" do %>
          üéØ 6-Month Protocol
        <% end %>
      </div>
    </div>

    <!-- Mini Analytics Bar -->
    <div class="mb-6">
      <div class="bg-base-100/80 backdrop-blur-xl rounded-2xl p-6 border border-base-300/50 shadow-lg">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-primary" id="focus-minutes">247</div>
            <div class="text-sm text-base-content/70">Focus Minutes</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-500" id="weekly-percentage">92%</div>
            <div class="text-sm text-base-content/70">This Week</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-500" id="total-habits">18</div>
            <div class="text-sm text-base-content/70">Total Habits</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-500" id="completion-rate">85%</div>
            <div class="text-sm text-base-content/70">Completion Rate</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Date Navigation (for Daily Plans) -->
    <% if @habit_plan.duration_type == 'daily' %>
      <div class="card bg-base-100 shadow-sm mb-6">
        <div class="card-body p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <%= link_to my_habit_plan_path(duration_type: @duration_type, date: @date - 1.day), 
                  class: "btn btn-circle btn-sm btn-ghost" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
              <% end %>
              
              <div class="text-center">
                <div class="text-lg font-semibold"><%= @date.strftime("%A, %B %d, %Y") %></div>
                <div class="flex items-center gap-2 justify-center">
                  <div class="text-sm text-gray-500">
                    <%= @date == Date.current ? "Today" : time_ago_in_words(@date) + (@date < Date.current ? " ago" : " from now") %>
                  </div>
                  <div class="badge badge-sm" id="daily-status">
                    <% if @habit_log&.completed_at.present? %>
                      ‚úÖ Complete
                    <% else %>
                      <span id="daily-progress">0% done</span>
                    <% end %>
                  </div>
                </div>
              </div>
              
              <%= link_to my_habit_plan_path(duration_type: @duration_type, date: @date + 1.day), 
                  class: "btn btn-circle btn-sm btn-ghost" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              <% end %>
            </div>
            
            <%= link_to my_habit_plan_path(duration_type: @duration_type, date: Date.current), 
                class: "btn btn-sm btn-primary" do %>
              Today
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- React Habit Plan Component -->
    <div id="habit-plan-root" 
         data-props="<%= {
           habitPlan: {
             id: @habit_plan.id,
             name: @habit_plan.name,
             description: @habit_plan.description,
             duration_type: @habit_plan.duration_type,
             current_streak: @habit_plan.current_streak,
             next_milestone: @habit_plan.next_milestone,
             plan_sections: @habit_plan.plan_sections.map { |section|
               {
                 id: section.id,
                 name: section.name,
                 plan_items: section.plan_items.map { |item|
                   {
                     id: item.id,
                     content: item.content
                   }
                 }
               }
             }
           },
           habitLog: @habit_log ? {
             id: @habit_log.id,
             date: @habit_log.date,
             completed_at: @habit_log.completed_at,
             plan_item_logs: @habit_log.plan_item_logs.map { |log|
               {
                 plan_item_id: log.plan_item_id,
                 completed_at: log.completed_at
               }
             }
           } : nil,
           date: @date,
           sectionPresenters: @section_presenters || []
         }.to_json.gsub("'", "&#39;") %>">
    </div>

  <% end %>
</div>

<script>
  // Stimulus controllers for habit tracking and journal
  // These would be in separate files in a real app
</script>

