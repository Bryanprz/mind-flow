<% content_for :vite_page, true %>
<% content_for :main_container_class, 'w-full bg-base-200 min-h-screen' %>

<div class="container mx-auto px-4 py-8 max-w-7xl">
  <%= render 'shared/flash' if flash.any? %>

  <% if @habit_plan.nil? %>
    <!-- No Plan Found for Selected Duration -->
    <div class="min-h-screen bg-base-200 flex items-center justify-center">
      <div class="card bg-base-100 shadow-xl max-w-md">
        <div class="card-body text-center">
          <h2 class="card-title text-2xl justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </h2>
          <h3 class="text-xl font-semibold mb-2">No <%= @duration_type.titleize %> Plan Found</h3>
          <p class="text-base-content/70 mb-4">You don't have a <%= @duration_type.titleize %> habit plan yet.</p>
          <%= link_to "Back to Dashboard", dashboard_path, class: "btn btn-primary" %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- Enhanced Habit Plan Header -->
    <div class="mb-8">
      <!-- Header with gradient background -->
      <div class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-purple-600 via-pink-600 to-blue-600 p-8 mb-6">
        <div class="absolute inset-0 bg-black/20"></div>
        <div class="relative">
          <div class="flex items-center justify-between mb-6">
            <div class="flex-1">
              <h1 class="text-4xl font-black text-white mb-2">
                <%= case Time.current.hour
                    when 5..11 then "ðŸŒ… Morning Activation"
                    when 12..17 then "âš¡ Afternoon Focus"
                    when 18..21 then "ðŸŒ™ Evening Routine"
                    else "ðŸŽ¯ Daily Protocol"
                    end %>
              </h1>
              <p class="text-white/90 text-lg"><%= @habit_plan.description %></p>
            </div>
            <div class="flex gap-3">
              <%= link_to dashboard_path, class: "btn btn-ghost btn-lg text-white hover:bg-white/20" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                Dashboard
              <% end %>
            </div>
          </div>

          <!-- Stats cards in header -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
              <div class="flex items-center gap-3">
                <div class="text-3xl">ðŸ”¥</div>
                <div>
                  <div class="text-white/70 text-sm">Current Streak</div>
                  <div class="text-2xl font-bold text-white"><%= @habit_plan.current_streak || 0 %> days</div>
                </div>
              </div>
            </div>
            
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
              <div class="flex items-center gap-3">
                <div class="text-3xl">ðŸ“Š</div>
                <div>
                  <div class="text-white/70 text-sm">Weekly Average</div>
                  <div class="text-2xl font-bold text-white" id="weekly-average">-</div>
                </div>
              </div>
            </div>
            
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
              <div class="flex items-center gap-3">
                <div class="text-3xl">ðŸŽ¯</div>
                <div>
                  <div class="text-white/70 text-sm">Next Milestone</div>
                  <div class="text-2xl font-bold text-white"><%= @habit_plan.next_milestone || 30 %> days</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Duration Type Tabs -->
      <div class="flex gap-2 p-1 bg-base-100 rounded-2xl shadow-lg w-fit">
        <%= link_to my_habit_plan_path(duration_type: 'daily'), 
            class: "px-6 py-3 rounded-xl font-semibold transition-all duration-300 #{@duration_type == 'daily' ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white shadow-lg' : 'text-base-content hover:bg-base-200'}" do %>
          ðŸš€ Today's Stack
        <% end %>
        <%= link_to my_habit_plan_path(duration_type: 'three_month'), 
            class: "px-6 py-3 rounded-xl font-semibold transition-all duration-300 #{@duration_type == 'three_month' ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white shadow-lg' : 'text-base-content hover:bg-base-200'}" do %>
          ðŸ“ˆ This Quarter
        <% end %>
        <%= link_to my_habit_plan_path(duration_type: 'six_month'), 
            class: "px-6 py-3 rounded-xl font-semibold transition-all duration-300 #{@duration_type == 'six_month' ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white shadow-lg' : 'text-base-content hover:bg-base-200'}" do %>
          ðŸŽ¯ 6-Month Protocol
        <% end %>
      </div>
    </div>

    <!-- Mini Analytics Bar -->
    <div class="mb-6">
      <div class="bg-base-100/80 backdrop-blur-xl rounded-2xl p-6 border border-base-300/50 shadow-lg">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-primary" id="focus-minutes">247</div>
            <div class="text-sm text-base-content/70">Focus Minutes</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-500" id="weekly-percentage">92%</div>
            <div class="text-sm text-base-content/70">This Week</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-500" id="total-habits">18</div>
            <div class="text-sm text-base-content/70">Total Habits</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-500" id="completion-rate">85%</div>
            <div class="text-sm text-base-content/70">Completion Rate</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Date Navigation (for Daily Plans) -->
    <% if @habit_plan.duration_type == 'daily' %>
      <div class="card bg-base-100 shadow-sm mb-6">
        <div class="card-body p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <%= link_to my_habit_plan_path(duration_type: @duration_type, date: @date - 1.day), 
                  class: "btn btn-circle btn-sm btn-ghost" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
              <% end %>
              
              <div class="text-center">
                <div class="text-lg font-semibold"><%= @date.strftime("%A, %B %d, %Y") %></div>
                <div class="flex items-center gap-2 justify-center">
                  <div class="text-sm text-gray-500">
                    <%= @date == Date.current ? "Today" : time_ago_in_words(@date) + (@date < Date.current ? " ago" : " from now") %>
                  </div>
                  <div class="badge badge-sm" id="daily-status">
                    <% if @habit_log&.completed_at.present? %>
                      âœ… Complete
                    <% else %>
                      <span id="daily-progress">0% done</span>
                    <% end %>
                  </div>
                </div>
              </div>
              
              <%= link_to my_habit_plan_path(duration_type: @duration_type, date: @date + 1.day), 
                  class: "btn btn-circle btn-sm btn-ghost" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              <% end %>
            </div>
            
            <%= link_to my_habit_plan_path(duration_type: @duration_type, date: Date.current), 
                class: "btn btn-sm btn-primary" do %>
              Today
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- React Habit Plan Component -->
    <div id="habit-plan-root" 
         data-props="<%= {
           habitPlan: {
             id: @habit_plan.id,
             name: @habit_plan.name,
             description: @habit_plan.description,
             duration_type: @habit_plan.duration_type,
             current_streak: @habit_plan.current_streak,
             next_milestone: @habit_plan.next_milestone,
             plan_sections: @habit_plan.plan_sections.map { |section|
               {
                 id: section.id,
                 name: section.name,
                 plan_items: section.plan_items.map { |item|
                   {
                     id: item.id,
                     content: item.content
                   }
                 }
               }
             }
           },
           habitLog: @habit_log ? {
             id: @habit_log.id,
             date: @habit_log.date,
             completed_at: @habit_log.completed_at,
             plan_item_logs: @habit_log.plan_item_logs.map { |log|
               {
                 plan_item_id: log.plan_item_id,
                 completed_at: log.completed_at
               }
             }
           } : nil,
           date: @date,
           sectionPresenters: @section_presenters || []
         }.to_json.gsub("'", "&#39;") %>">
    </div>

  <% end %>
</div>

<script>
  // Stimulus controllers for habit tracking and journal
  // These would be in separate files in a real app
</script>

