<% completed_item_ids = @healing_plan_log&.completed_item_ids || [] %>

<div class="max-w-xl mx-auto p-6 space-y-6" data-controller="healing-plan-progress" data-healing-plan-progress-healing-plan-id-value="<%= @healing_plan.id %>" data-healing-plan-progress-healing-plan-log-id-value="<%= @healing_plan_log&.id %>" data-healing-plan-progress-date-value="<%= @date.iso8601 %>">
  
  <!-- Hero / Intro -->
  <div class="card bg-base-100 border border-gray-300">
    <div class="card-body">
      <h1 class="card-title text-2xl">
        <%= @healing_plan.name %> - Daily for <%= @date.strftime("%B %d") %>
      </h1>
      <% if @healing_plan.description.present? %>
        <div class="prose max-w-none mt-3">
          <%= @healing_plan.description %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Progress & Streak -->
  <div class="card bg-base-100 border border-gray-300">
    <div class="card-body">
      <div class="flex justify-between items-center mb-2">
        <h2 class="card-title text-xl">Daily Progress</h2>
        <div class="font-bold text-lg">
          ðŸ”¥ 0 Day Streak! <%# TODO: Implement streak logic %>
        </div>
      </div>
      <progress data-healing-plan-progress-target="progress" class="progress progress-success w-full" value="0" max="100"></progress>
    </div>
  </div>

  <!-- Overview Dashboard -->
  <% overview = @healing_plan.overview || {} %>
  <% has_overview = (0..3).any? { |i| overview["focus_area_#{i}"].present? || overview["goal_#{i}"].present? } %>
  
  <% if has_overview %>
    <div class="card bg-base-100 border border-gray-300">
      <div class="card-body">
        <h2 class="card-title text-xl">Overview</h2>
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>Focus Area</th>
                <th>Goal</th>
              </tr>
            </thead>
            <tbody>
              <% (0..3).each do |index| %>
                <% focus = overview["focus_area_#{index}"] %>
                <% goal  = overview["goal_#{index}"] %>
                <% next if focus.blank? && goal.blank? %>
                <tr>
                  <td><%= focus %></td>
                  <td><%= goal %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Main Content Sections -->
  <% @healing_plan.sections.order(:position).each do |section| %>
    <% next if section.plan_items.empty? %>
    <% next if section.name == "Focus Areas" %>
    
    <div class="card bg-base-100 border border-gray-300">
      <div class="card-body">
        <h2 class="card-title text-xl"><%= section.name %></h2>
        
        <div class="space-y-4 mt-4">
          <% section.plan_items.order(:position).each do |item| %>
            <div data-healing-plan-progress-target="item" class="py-1">
              <label class="label cursor-pointer justify-start p-0">
                <input 
                  type="checkbox" 
                  class="checkbox checkbox-success mr-4" 
                  data-action="healing-plan-progress#toggle"
                  data-plan-item-id="<%= item.id %>" 
                  <%= 'checked' if completed_item_ids.include?(item.id) %> />
                <span class="label-text"><%= simple_format(item.content) %></span>
              </label>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Progress & Reflection -->
  <div class="card bg-base-100 border border-gray-300">
    <div class="card-body">
      <h2 class="card-title text-xl">Progress & Reflection</h2>
      
      <!-- Journal View (always present) -->
      <div data-healing-plan-progress-target="journalView" class="<%= 'hidden' unless @healing_plan_log&.journal_entry.present? %>">
        <p class="font-semibold mt-4">Your Journal Entry:</p>
        <div class="prose max-w-none bg-base-200 rounded-lg p-3 my-2 mt-3"><%= @healing_plan_log&.journal_entry %></div>
        <button data-action="click->healing-plan-progress#editJournal" class="btn btn-sm btn-outline mt-3">Edit</button>
      </div>
      
      <!-- Journal Textarea (always present) -->
      <textarea data-healing-plan-progress-target="journal" class="textarea textarea-bordered w-full mt-3 <%= 'hidden' if @healing_plan_log&.journal_entry.present? %>" placeholder="Journal: How did you feel today?"><%= @healing_plan_log&.journal_entry %></textarea>
    </div>
  </div>

  <!-- CTA -->
  <div class="card bg-base-100 border border-gray-300">
    <div class="card-body text-center">
      <% if @healing_plan_log&.completed_at.present? %>
        <!-- User has already completed their daily plan -->
        <p class="mb-3">Great job! You've completed your daily plan for <%= @date.strftime("%B %d") %> ðŸŽ‰</p>
        <div class="flex justify-center gap-4">
          <button type="button" 
                  data-action="healing-plan-progress#savePlan" 
                  data-healing-plan-progress-target="saveButton"
                  class="btn btn-primary text-white <%= 'btn-disabled' if @healing_plan_log&.journal_entry.present? %>"
                  <%= 'disabled' if @healing_plan_log&.journal_entry.present? %>>
            Save Daily Plan
          </button>
          <%= button_to "Export as PDF", "#", method: :get, class: "btn btn-outline" %>
        </div>
      <% else %>
        <!-- User hasn't completed their daily plan yet -->
        <p class="mb-3">Follow this plan for 7 days, then reflect on your progress ðŸŒ±</p>
        <div class="flex justify-center gap-4">
          <button type="button" 
                  data-action="healing-plan-progress#savePlan" 
                  data-healing-plan-progress-target="saveButton"
                  class="btn btn-primary text-white <%= 'btn-disabled' if @healing_plan_log&.journal_entry.present? %>"
                  <%= 'disabled' if @healing_plan_log&.journal_entry.present? %>>
            Save Daily Plan
          </button>
          <%= button_to "Export as PDF", "#", method: :get, class: "btn btn-outline" %>
        </div>
      <% end %>
    </div>
  </div>
</div>