<% content_for :main_container_class, 'min-h-screen bg-neutral' %>
<% content_for :hide_footer, true %>
<% content_for :hide_navigation, true %>

<div class="min-h-full">
  <!-- Main content -->
  <div class="drawer-content flex flex-col h-screen">
    <div class="flex-1 overflow-y-auto lg:overflow-hidden">
      <div class="max-w-2xl mx-auto min-h-screen flex flex-col relative">
      
      <!-- Vertical Lines (covering entire height) -->
      <div class="absolute left-0 top-0 bottom-0 w-px bg-primary z-10"></div>
      <div class="absolute right-0 top-0 bottom-0 w-px bg-primary z-10"></div>
      
      <!-- Header -->
      <div class="flex-shrink-0 px-2 md:p-4 border-b border-primary">
        <div class="flex justify-between items-center">
          <%= link_to "â† Back to Dashboard", dashboard_path, 
              class: "text-primary hover:text-primary-focus hover:bg-primary/10 text-sm font-medium px-2 py-1 rounded transition-colors" %>
          <h1 class="md:text-2xl pr-4 sm:pr-0 text-lg font-bold text-primary">Messages</h1>
          <%= link_to "ðŸ  Public Rooms", rooms_path, 
              class: "btn btn-ghost btn-sm border border-primary text-primary hover:bg-primary hover:text-primary-content" %>
        </div>
      </div>
      
      <!-- Messages Container -->
      <div class="flex-1 relative overflow-hidden">
        <div class="overflow-y-auto p-4">
          <% if @user_rooms.any? %>
            <% @user_rooms.each do |room| %>
              <% last_message = room.messages.order(created_at: :desc).first %>
              <%= link_to room_path(room), class: "group block mb-4 p-4 hover:bg-primary/10 hover:text-primary transition-all duration-200 rounded-lg" do %>
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full overflow-hidden">
                      <% if room.room_type == 'private' %>
                        <% other_user = room.other_user(Current.user) %>
                        <% if other_user %>
                          <% if other_user.avatar.attached? %>
                            <%= avatar_image_with_cache(other_user, "w-full h-full object-cover", 
                                                       loading: "eager") %>
                          <% else %>
                            <div class="w-full h-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-semibold">
                              <%= other_user.name[0].upcase %>
                            </div>
                          <% end %>
                        <% else %>
                          <div class="w-full h-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-semibold">
                            <%= room.name.first.upcase %>
                          </div>
                        <% end %>
                      <% else %>
                        <div class="w-full h-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-semibold">
                          <%= room.name.first.upcase %>
                        </div>
                      <% end %>
                    </div>
                    <div>
                      <h3 class="font-semibold text-sm text-neutral-content group-hover:text-primary">
                        <% if room.room_type == 'private' %>
                          <% other_user = room.other_user(Current.user) %>
                          <% if other_user %>
                            <%= other_user.name %>
                          <% else %>
                            <%= room.name %>
                          <% end %>
                        <% else %>
                          <%= room.name %>
                        <% end %>
                      </h3>
                      <p class="text-xs text-gray-400 group-hover:text-primary">
                        <% if room.room_type == 'private' %>
                          <span class="text-blue-600 group-hover:text-primary">Private conversation</span>
                        <% else %>
                          <span class="text-green-600 group-hover:text-primary">Public room</span>
                        <% end %>
                      </p>
                    </div>
                  </div>
                  <span class="text-xs text-gray-500 group-hover:text-primary">
                    <% if last_message %>
                      <%= time_ago_in_words(last_message.created_at) %> ago
                    <% else %>
                      No messages yet
                    <% end %>
                  </span>
                </div>
                
                <div class="ml-10">
                  <% if last_message %>
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-xs text-gray-500 group-hover:text-primary">
                        <%= last_message.user.name %>:
                      </span>
                    </div>
                    <% if last_message.content.present? %>
                      <p class="text-neutral-content group-hover:text-primary mb-2">
                        <%= last_message.content.to_plain_text.truncate(100) %>
                      </p>
                    <% end %>
                    
                    <!-- Show last attachment if any -->
                    <% if last_message.attachments.any? %>
                      <div class="flex flex-wrap gap-2 mb-2">
                        <% last_message.attachments.first(1).each do |attachment| %>
                          <% if attachment.image? %>
                            <div class="w-12 h-12 rounded-lg overflow-hidden">
                              <%= image_tag attachment, class: "w-full h-full object-cover" %>
                            </div>
                          <% else %>
                            <div class="flex items-center gap-1 px-2 py-1 bg-gray-100 rounded text-xs">
                              ðŸ“Ž <%= attachment.filename %>
                            </div>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  <% else %>
                    <p class="text-neutral-content group-hover:text-green-300 text-sm italic">
                      Start a conversation...
                    </p>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="bg-neutral text-neutral-content rounded-lg shadow p-8 text-center">
              <div class="text-neutral-content">
                <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <h3 class="text-lg font-semibold mb-2">No messages yet</h3>
                <p class="text-neutral-content">Start a conversation by visiting someone's profile and clicking "Send Private Message"</p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
