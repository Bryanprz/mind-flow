<% content_for :main_container_class, 'bg-base-200' %>

<div class="container mx-auto px-4 py-8">

  <%= form_with(model: [:admin, @user, @healing_plan], url: admin_user_healing_plan_path(@user, @healing_plan)) do |form| %>
    <% if @healing_plan.errors.any? %>
      <div class="alert alert-error">
        <ul>
          <% @healing_plan.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="card w-full max-w-2xl mx-auto bg-base-100 border border-gray-300 mb-6">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">Edit Healing Plan for <%= @user.name %></h2>

        <div class="form-control">
          <%= form.label :name, class: "label" %>
          <%= form.text_field :name, class: "input input-bordered" %>
        </div>

        <div class="form-control">
          <%= form.label :description, class: "label" %>
          <%= form.hidden_field :description, id: "healing_plan_description" %>
          <trix-editor 
            input="healing_plan_description" 
            class="trix-content min-h-[300px] bg-base-100 rounded-lg p-4 border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent"
            data-direct-upload-url="<%= rails_direct_uploads_path %>"
            data-blob-url-template="<%= rails_service_blob_path(":signed_id", ":filename") %>"
          ><%= @healing_plan.description&.body&.to_s&.html_safe %></trix-editor>
        </div>
      </div>
    </div>

    <h3 class="text-2xl font-bold mb-4 max-w-2xl mx-auto">Overview (Focus Areas & Goals)</h3>
    <% (0..3).each do |index| %>
      <div class="card w-full max-w-2xl mx-auto bg-base-100 border border-gray-300 mb-6" id="overview_item_<%= index %>">
        <div class="card-body">
          <div class="flex justify-between items-center mb-2">
            <div class="form-control flex-grow mr-2">
              <%= form.label "focus_area_#{index}", "Focus Area #{index + 1}", class: "label" %>
              <%= form.text_field "focus_area_#{index}", class: "input input-bordered" %>
            </div>
            <div class="form-control flex-grow">
              <%= form.label "goal_#{index}", "Goal #{index + 1}", class: "label" %>
              <%= form.text_field "goal_#{index}", class: "input input-bordered" %>
            </div>
            <div class="ml-4">
              <button type="button" class="btn btn-ghost btn-sm text-error" onclick="
                document.getElementById('overview_item_<%= index %>').style.display = 'none';
                document.getElementById('<%= form.field_id("focus_area_#{index}") %>').value = '';
                document.getElementById('<%= form.field_id("goal_#{index}") %>').value = '';
              ">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <h3 class="text-2xl font-bold mb-4 max-w-2xl mx-auto">Plan Sections</h3>

    <%= form.fields_for :plan_sections do |section_form| %>
      <% # Only exclude Focus Areas from the sections loop %>
      <% next if section_form.object.name == "Focus Areas" %>
      <div class="card w-full max-w-2xl mx-auto bg-base-100 border border-gray-300 mb-6">
        <div class="card-body">
          <div class="flex justify-between items-center mb-2">
            <div class="form-control flex-grow">
              <%= section_form.label :name, "Section Name", class: "label" %>
              <%= section_form.text_field :name, class: "input input-bordered" %>
            </div>
            <div class="ml-4">
              <%= section_form.hidden_field :_destroy, value: section_form.object.marked_for_destruction? ? 1 : 0, id: "section_destroy_#{section_form.object.id}" %>
              <button type="button" class="btn btn-ghost btn-sm text-error" onclick="document.getElementById('section_destroy_<%= section_form.object.id %>').value = 1; this.closest('.card').style.display = 'none';">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>

          <div class="divider mt-4 mb-2">
            <div class="flex items-center justify-between w-full">
              <span>Plan Items</span>
              <button type="button" class="btn btn-sm btn-ghost" onclick="addPlanItem(this, '<%= section_form.index %>')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Item
              </button>
            </div>
          </div>
          
          <div class="plan-items-container" data-section-index="<%= section_form.index %>">
          <% section_form.object.plan_items.order(:ordering).each do |item| %>
            <%= section_form.fields_for :plan_items, item do |item_form| %>
              <div class="flex justify-between items-center mb-2">
                <div class="form-control flex-grow">
                  <%= item_form.label :content, "Item Content", class: "label" %>
                  <%= item_form.text_area :content, rows: 2, class: "textarea textarea-bordered" %>
                </div>
                <div class="ml-4">
                  <%= item_form.hidden_field :_destroy, value: item_form.object.marked_for_destruction? ? 1 : 0, id: "item_destroy_#{item_form.object.id}" %>
                  <button type="button" class="btn btn-ghost btn-sm text-error" onclick="document.getElementById('item_destroy_<%= item_form.object.id %>').value = 1; this.closest('.flex').style.display = 'none';">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    
    <div class="card w-full max-w-2xl mx-auto bg-base-100 border border-gray-300 mb-6">
      <div class="card-body">
        <div class="card-actions justify-end">
          <%= form.submit "Update Healing Plan", class: "btn btn-primary" %>
          <%= link_to "Cancel", admin_user_healing_plan_path(@user, @healing_plan), class: "btn btn-ghost" %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
  function addPlanItem(button, sectionIndex) {
    // Find the container for this section's items
    const container = button.closest('.card-body').querySelector('.plan-items-container');
    const timestamp = new Date().getTime();
    const newItem = document.createElement('div');
    newItem.className = 'flex justify-between items-center mb-2';
    
    // Create a unique ID for the new item
    const newItemId = timestamp;
    
    // Create the new item HTML
    newItem.innerHTML = `
      <div class="form-control flex-grow">
        <label class="label">Item</label>
        <textarea name="healing_plan[plan_sections_attributes][${sectionIndex}][plan_items_attributes][${newItemId}][content]" 
                  class="textarea textarea-bordered w-full" 
                  rows="2"
                  placeholder="Enter plan item content"></textarea>
        <input type="hidden" 
               name="healing_plan[plan_sections_attributes][${sectionIndex}][plan_items_attributes][${newItemId}][id]" 
               value="">
      </div>
      <div class="ml-4">
        <input type="hidden" 
               name="healing_plan[plan_sections_attributes][${sectionIndex}][plan_items_attributes][${newItemId}][_destroy]" 
               value="0" 
               id="item_destroy_${newItemId}">
        <button type="button" class="btn btn-ghost btn-sm text-error" 
                onclick="document.getElementById('item_destroy_${newItemId}').value = '1'; this.closest('.flex').style.display = 'none';">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    `;
    
    // Add the new item to the container
    container.appendChild(newItem);
    
    // Scroll to the new item
    newItem.scrollIntoView({ behavior: 'smooth' });
    
    // Focus the new textarea
    const newTextarea = newItem.querySelector('textarea');
    if (newTextarea) {
      newTextarea.focus();
    }
  }
  
  // Keep the existing addDietItem function for backward compatibility
  function addDietItem() {
    // This is kept for backward compatibility but now uses the new function
    const button = document.querySelector('.plan-items-container[data-section-index="0"]')?.closest('.card-body')?.querySelector('button[onclick^="addPlanItem"]');
    if (button) {
      addPlanItem(button, 0);
    }
  }
</script>