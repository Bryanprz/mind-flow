<% content_for :main_container_class, 'bg-base-200' %>

<div class="container mx-auto px-4 py-8">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold">Edit Healing Plan</h1>
        <p class="text-lg text-gray-600">for <%= @user.name %></p>
      </div>
      <%= link_to "â† Back", admin_user_healing_plan_path(@user, @healing_plan), class: "btn btn-ghost" %>
    </div>

    <!-- Form -->
    <%= form_with(model: [:admin, @user, @healing_plan], local: true, data: { turbo: false }) do |form| %>
      <% if @healing_plan.errors.any? %>
        <div class="alert alert-error shadow-lg mb-6">
          <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span><%= pluralize(@healing_plan.errors.count, "error") %> prohibited this healing plan from being saved:</span>
          </div>
          <ul class="mt-2">
            <% @healing_plan.errors.each do |error| %>
              <li><%= error.full_message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Basic Information -->
      <div class="card bg-base-100 border border-gray-300 mb-6">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">Basic Information</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <%= form.label :name, class: "label" %>
              <%= form.text_field :name, class: "input input-bordered w-full", placeholder: "e.g., Hector's Daily Wellness Plan" %>
            </div>
            
            <div class="form-control">
              <%= form.label :duration_type, class: "label" %>
              <%= form.select :duration_type, 
                  options_for_select([
                    ['Daily', 'daily'],
                    ['Three Month', 'three_month'],
                    ['Six Month', 'six_month']
                  ], @healing_plan.duration_type),
                  { prompt: "Select duration type" },
                  { class: "select select-bordered w-full" } %>
            </div>
          </div>

          <div class="form-control mt-4">
            <%= form.label :description, class: "label" %>
            <%= form.rich_text_area :description, class: "textarea textarea-bordered w-full", rows: 4, placeholder: "Describe the purpose and goals of this healing plan..." %>
          </div>
        </div>
      </div>

      <!-- Focus Areas & Goals -->
      <div class="card bg-base-100 border border-gray-300 mb-6">
        <div class="card-body">
          <h2 class="card-title text-xl mb-4">Focus Areas & Goals</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <% (0..3).each do |index| %>
              <div class="space-y-2">
                <div class="form-control">
                  <%= form.label "focus_area_#{index}".to_sym, "Focus Area #{index + 1}", class: "label" %>
                  <%= form.text_field "focus_area_#{index}".to_sym, 
                      value: @healing_plan.overview&.dig("focus_area_#{index}"),
                      class: "input input-bordered w-full", 
                      placeholder: "e.g., Digestive Health" %>
                </div>
                <div class="form-control">
                  <%= form.label "goal_#{index}".to_sym, "Goal #{index + 1}", class: "label" %>
                  <%= form.text_field "goal_#{index}".to_sym, 
                      value: @healing_plan.overview&.dig("goal_#{index}"),
                      class: "input input-bordered w-full", 
                      placeholder: "e.g., Improve gut health" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Plan Sections -->
      <div class="card bg-base-100 border border-gray-300 mb-6">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-xl">Plan Sections</h2>
            <button type="button" class="btn btn-primary btn-sm text-white" onclick="addNewSection()">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Add Section
            </button>
          </div>

          <div id="plan-sections" class="space-y-4">
            <%= form.fields_for :plan_sections do |section_form| %>
              <div class="border border-gray-200 rounded-lg p-4 section-item" data-section-index="<%= section_form.index %>">
                <div class="flex justify-between items-center mb-3">
                  <div class="flex items-center gap-3">
                    <div class="form-control">
                      <%= section_form.label :name, "Section Name", class: "label text-sm" %>
                      <%= section_form.text_field :name, class: "input input-bordered input-sm w-48", placeholder: "e.g., Morning Routine" %>
                    </div>
                    <div class="form-control">
                      <%= section_form.label :position, "Position", class: "label text-sm" %>
                      <%= section_form.number_field :position, class: "input input-bordered input-sm w-20" %>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button type="button" class="btn btn-ghost btn-xs" onclick="addItem(this, <%= section_form.index %>)">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                      </svg>
                      Add Item
                    </button>
                    <%= section_form.check_box :_destroy, class: "checkbox checkbox-sm", onchange: "toggleSection(this)" %>
                    <label class="text-xs">Delete</label>
                  </div>
                </div>

                <div class="items-container space-y-2" data-section="<%= section_form.index %>">
                  <%= section_form.fields_for :plan_items do |item_form| %>
                    <div class="flex items-start gap-2 p-2 bg-gray-50 rounded item-row" data-item-index="<%= item_form.index %>">
                      <div class="flex-1">
                        <%= item_form.rich_text_area :content, class: "textarea textarea-bordered textarea-sm w-full", rows: 2, placeholder: "Enter plan item..." %>
                      </div>
                      <div class="flex items-center gap-2">
                        <%= item_form.number_field :position, class: "input input-bordered input-sm w-16", placeholder: "#" %>
                        <%= item_form.check_box :_destroy, class: "checkbox checkbox-sm" %>
                        <label class="text-xs">Del</label>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex gap-2 justify-end">
        <%= link_to "Cancel", admin_user_healing_plan_path(@user, @healing_plan), class: "btn btn-ghost" %>
        <%= form.submit "Update Healing Plan", class: "btn btn-primary text-white" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  let sectionCounter = <%= @healing_plan.plan_sections.count %>;
  let itemCounters = {};

  function addNewSection() {
    const container = document.getElementById('plan-sections');
    const newSection = document.createElement('div');
    newSection.className = 'border border-gray-200 rounded-lg p-4 section-item';
    newSection.setAttribute('data-section-index', sectionCounter);
    
    newSection.innerHTML = `
      <div class="flex justify-between items-center mb-3">
        <div class="flex items-center gap-3">
          <div class="form-control">
            <label class="label text-sm">Section Name</label>
            <input type="text" name="healing_plan[plan_sections_attributes][${sectionCounter}][name]" 
                   class="input input-bordered input-sm w-48" placeholder="e.g., Morning Routine">
          </div>
          <div class="form-control">
            <label class="label text-sm">Position</label>
            <input type="number" name="healing_plan[plan_sections_attributes][${sectionCounter}][position]" 
                   class="input input-bordered input-sm w-20" value="${sectionCounter + 1}">
          </div>
        </div>
        <div class="flex gap-2">
          <button type="button" class="btn btn-ghost btn-xs" onclick="addItem(this, ${sectionCounter})">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Item
          </button>
          <input type="checkbox" class="checkbox checkbox-sm" onchange="toggleSection(this)">
          <label class="text-xs">Delete</label>
        </div>
      </div>
      <div class="items-container space-y-2" data-section="${sectionCounter}"></div>
    `;
    
    container.appendChild(newSection);
    itemCounters[sectionCounter] = 0;
    sectionCounter++;
  }

  function addItem(button, sectionIndex) {
    if (!itemCounters[sectionIndex]) {
      itemCounters[sectionIndex] = 0;
    }
    
    const container = button.closest('.section-item').querySelector('.items-container');
    const itemIndex = itemCounters[sectionIndex];
    
    const newItem = document.createElement('div');
    newItem.className = 'flex items-start gap-2 p-2 bg-gray-50 rounded item-row';
    newItem.innerHTML = `
      <div class="flex-1">
        <textarea name="healing_plan[plan_sections_attributes][${sectionIndex}][plan_items_attributes][${itemIndex}][content]" 
                  class="textarea textarea-bordered textarea-sm w-full" rows="2" placeholder="Enter plan item..."></textarea>
      </div>
      <div class="flex items-center gap-2">
        <input type="number" name="healing_plan[plan_sections_attributes][${sectionIndex}][plan_items_attributes][${itemIndex}][position]" 
               class="input input-bordered input-sm w-16" value="${itemIndex + 1}" placeholder="#">
        <input type="checkbox" class="checkbox checkbox-sm" name="healing_plan[plan_sections_attributes][${sectionIndex}][plan_items_attributes][${itemIndex}][_destroy]">
        <label class="text-xs">Del</label>
      </div>
    `;
    
    container.appendChild(newItem);
    itemCounters[sectionIndex]++;
  }

  function toggleSection(checkbox) {
    const section = checkbox.closest('.section-item');
    if (checkbox.checked) {
      section.style.opacity = '0.5';
      section.style.pointerEvents = 'none';
    } else {
      section.style.opacity = '1';
      section.style.pointerEvents = 'auto';
    }
  }

  // Initialize item counters for existing sections
  document.querySelectorAll('.section-item').forEach(section => {
    const sectionIndex = section.getAttribute('data-section-index');
    const items = section.querySelectorAll('.item-row');
    itemCounters[sectionIndex] = items.length;
  });
</script>